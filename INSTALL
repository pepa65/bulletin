#!/usr/bin/env bash

# INSTALL - Run this to install piscreen/bulletin
# Usage:  bash INSTALL <URL> | <BASEURL> <SITE>
#   If the full URL to a webpage is given, 'piscreen' gets installed,
#   otherwise 'bulletin' will get served on SITE (IP:PORT of the Pi).
#   Environment variables URL BASEURL SITE can be set before running this.
# Required: sudo apt-get coreutils(cd mkdir cp chmod head ln) git grep sed cron

sudo apt-get install -y git surf unclutter xdotool lxsession php-fpm

cd
pwd=$PWD
mkdir git
cd git
git clone 'https://gitlab.com/pepa65/bulletin'
cd bulletin

cp _show show
chmod +x show
[[ $2 ]] && SITE=$2
[[ $SITE ]] || ip=$(ip a |grep -o 'inet[^ ]* [^/]*' |grep -v ' 127.' |grep -v ' ::1' |head -1) SITE=${ip##* }:8888
sed -i 's@"$SITE"@'$SITE'@' show
sed -i 's@"$URL"@'$1'@' show

[[ ! $pwd = /home/pi ]] &&
	sed -i "s@/home/pi@$pwd@" autostart &&
	sed -i "s@/home/pi@$pwd@" displ
lxconfdir=$pwd/.config/lxsession/LXDE
shopt -s nullglob
n=$(echo "$lxconfdir"* |wc -w)
((n)) || mkdir -p "$lxconfdir"
for d in "$lxconfdir"*
do [[ -f "$d/autostart" ]] && mv -n "$d/autostart" "$d/autostart_orig"
	ln -sf "autostart" "$d"
done

crontab < <(crontab -l; echo -e "\n# Display On at 7:00 Mo-Fr on a schoolday\n"'0 7 * * 1-5' "$PWD/displ\n\n# Display Off at 17:00 Mo-Fr\n"'0 17 * * 1-5' "$PWD/displ off\n")
