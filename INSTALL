#!/usr/bin/env bash

# INSTALL - Run this to install piscreen/bulletin
# Usage: INSTALL [URL]
#   If the full URL is given, 'piscreen' gets installed, otherwise 'bulletin'
#   Environment variables IP & PORT can be set for an IP address and port.

apt-get install -y git chromium-browser unclutter xdotool lxsession php-fpm

cd -
pwd=$PWD
mkdir git
cd git
git clone 'https://gitlab.com/pepa65/bulletin'
cd bulletin

cp _websrv websrv
chmod + websrv
[[ $IP ]] || ip=$(ip a |grep -o 'inet[^ ]* [^/]*' |grep -v ' 127.' |grep -v ' ::1' |head -1) IP=${ip##* }
: ${PORT:=8888}
sed -i "s@%IP@$IP@" websrv
sed -i "s@%PORT@$PORT@" websrv

cp _autostart autostart
# The sed s delimiters are tab-characters to avoid clashes with the URL!
[[ $1 ]] && sed -i "s	%URL	$1	" autostart ||
	sed -i "s	%URL	http://localhost:$PORT/index.html	" autostart
[[ ! $pwd = /home/pi ]] && sed -i "s@/home/pi@$pwd@" autostart
lxconfdir=$pwd/.config/lxsession/LXDE
mkdir -p "$lxconfdir"
ln -sf "$PWD/autostart" "$lxconfdir"

crontab < <(crontab -l; echo -e "\n# Display maybe On at 7:30 Mo-Fr\n"'30 7 * * 1-5' "$PWD/displ\n\n# Display Off at 17:00 Mo-Fr\n"'0 17 * * 1-5' "$PWD/displ off\n")
