#!/usr/bin/env bash

# INSTALL - Run this to install piscreen/bulletin
# Usage: INSTALL [URL]
#   If the full URL is given, 'piscreen' gets installed, otherwise 'bulletin'

apt-get install -y git chromium-browser unclutter xdotool lxsession php-fpm

ip=$(ip a |grep -o 'inet[^ ]* [^/]*' |grep -v ' 127.' |grep -v ' ::1' |head -1)
ip=${ip##* }
echo "$ip bulletin" |sudo tee -a /etc/hosts

cd -
pwd=$PWD
mkdir git
cd git
git clone 'https://gitlab.com/pepa65/bulletin'
cd bulletin
cp _autostart autostart
cp _websrv websrv
[[ ! $pwd = /home/pi ]] &&
	sed -i "s@/home/pi@$pwd@" autostart &&
	sed -i "s@/home/pi@$pwd@" websrv

lxconfdir=$pwd/.config/lxsession/LXDE
mkdir -p "$lxconfdir"
# The sed s delimiters are tab-characters to avoid clashes with the URL!
[[ $1 ]] && sed -i "s	http://localhost:8888/index.html	$1	" autostart
ln -sf "$PWD/autostart" "$lxconfdir"

crontab < <(crontab -l; echo -e "\n# Display maybe On at 7:30 Mo-Fr\n"'30 7 * * 1-5' "$PWD/displ\n\n# Display Off at 17:00 Mo-Fr\n"'0 17 * * 1-5' "$PWD/displ off\n")
